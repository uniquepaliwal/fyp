<!-- Wappler include head-page="layouts/main" fontawesome_5="cdn" bootstrap5="local" is="dmx-app" id="chatbot" appConnect="local" components="{dmxBootstrap5Navigation:{},dmxSockets:{},dmxFormatter:{},dmxDataTraversal:{},dmxBootstrap5Modal:{},dmxDatastore:{},dmxBootstrap5Toasts:{},dmxStateManagement:{}}" -->

<!-- modal accept -->
<style>
    .badge {
        background-color: #484c7f;
        color: white;
        border-radius: 50%;
        font-size: 11px;
    }

    .badge_padding_less_10 {
        padding: 5px 8px;
    }

    .badge_padding_more_10 {
        padding: 6px 6px;
    }
</style>
<div class="modal" id="modal2" is="dmx-bs5-modal" tabindex="-1">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Sure want to end chat? </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal" dmx-on:click="run([{run:{name:'scendchat',outputType:'text',action:`scEndChat.load({chat_id: ddChatsChating.data.chat_room_id})`}},{run:{name:'ddempty',outputType:'text',action:`ddChatsChating.select(\'\')`}},{wait:{delay:1000}},{run:{name:'scloadremchat',outputType:'text',action:`scChatListChating.load({})`}}])">Yes</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No</button>
            </div>
        </div>
    </div>
</div>

<!-- Routes -->
<meta name="ac:route" content="/chatbot">

<div class="row g-0">
    <div class="col-12 d-flex">
        <!-- Card: -->
        <div class="card card-chat border-right border-top-0 border-bottom-0  w380">
            <div class="px-4 py-3 py-md-4">
                <div class="input-group mb-3">
                    <input type="text" id="searchChats" class="form-control mb-1" placeholder="Search..." dmx-on:changed.debounce:600="scChatListChating.load({search: content.searchChats.value})">
                </div>
            </div>
            <div class="tab-pane fade show active" id="chat-recent" role="tabpanel">
                <ul class="list-unstyled list-group list-group-custom list-group-flush mb-0">
                    <div dmx-repeat:rchatlist="scChatListChating.data.finalChatList">
                        <li class="list-group-item px-md-4 py-3 py-md-4 open" dmx-on:click="ddChatsChating.select(chat_room_id);scChatListChating.load({search: content.searchChats.value})" dmx-class:open="ddChatsChating.data.chat_room_id==chat_room_id">
                            <a href="javascript:void(0);" class="d-flex">
                                <div class="avatar rounded no-thumbnail">{{end_user_name.split(' ')[0].substr(0,1).uppercase()+end_user_name.split(' ')[1].substr(0,1).uppercase()}}</div>
                                <div class="flex-fill ms-3 text-truncate">
                                    <h6 class="d-flex justify-content-between mb-0">
                                        <span>{{chat_name}}</span>
                                        <small class="msg-time">{{message_time?message_time.toDate().toISODate():'New'}}</small>
                                    </h6>
                                    <div class="d-flex justify-content-between mb-0">
                                        <span class="text-muted">chat with {{end_user_name}}</span>
                                        <span class="badge" dmx-class:badge_padding_less_10="unseen_messages&lt;10" dmx-class:badge_padding_more_10="unseen_messages&gt;=10" dmx-hide="unseen_messages==0||ddChatsChating.data.chat_room_id==chat_room_id">{{unseen_messages}}</span>
                                    </div>

                                </div>
                            </a>
                        </li>
                    </div>
                </ul>
            </div>
            <div class="card card-chat-body border-0  w-100 px-4 px-md-5 py-3 py-md-4 d-flex justify-content-center align-items-center" dmx-show="scChatListChating.data.finalChatList.isEmpty()">
                <h5>No Chats available</h5>
                <p>You can find new chat in - </p>
                <p>Waiting Room</p>
            </div>
        </div>
        <!-- Card: -->

        <div class="card card-chat-body border-0  w-100 px-4 px-md-5 py-3 py-md-4" dmx-show="ddChatsChating.data != null">

            <div class="chat-header d-flex justify-content-between align-items-center border-bottom pb-3">
                <div class="d-flex align-items-center">
                    <a href="javascript:void(0);" title="">
                        <div class="avatar rounded no-thumbnail">{{ddChatsChating.data.end_user_name.split(' ')[0].substr(0,1).uppercase() + ddChatsChating.data.end_user_name.split(' ')[1].substr(0,1).uppercase()}}</div>
                    </a>
                    <div class="ms-3">
                        <h6 class="mb-0">{{ddChatsChating.data.chat_name}}</h6>
                        <small class="text-muted">Chat With - {{ddChatsChating.data.end_user_name}}</small>
                    </div>
                </div>
                <div class="ms-auto"><button class="btn btn-secondary" dmx-on:click="modal2.show()">End</button></div>
            </div>

            <!-- Chat: body -->
            <ul id="ulChatList" class="chat-history list-unstyled mb-0 py-lg-5 py-md-4 py-3 flex-grow-1">
                <div dmx-repeat:rmessagelist="scMessagesChating.data.listMessages">
                    <!-- Chat: left -->
                    <li class="mb-3 d-flex flex-row align-items-end" dmx-show="By!='Me'">
                        <div class="max-width-70">
                            <div class="user-info mb-2">
                                <span class="avatar sm rounded-circle me-1 p-2" style="background-color:rgba(72, 76, 127,0.15);">
                                    {{By.split(' ')[0].substr(0,1).uppercase()+By.split(' ')[1].substr(0,1).uppercase()}}
                                </span>
                                <span class="text-muted small">{{(time.toDate().toISODate() + " , " + time.toDate().toISOTime())}}</span>
                            </div>
                            <div class="card border-0 p-3">
                                <div class="message">{{Message}}</div>
                            </div>
                        </div>
                    </li>
                    <!-- Chat: right -->
                    <li class="mb-3 d-flex flex-row-reverse align-items-end" dmx-show="By=='Me'">
                        <div class="max-width-70 text-right">
                            <div class="user-info mb-1">
                                <span class="text-muted small">{{(time.toDate().toISODate() + " , " + time.toDate().toISOTime())}}</span>
                            </div>
                            <div class="card border-0 p-3 bg-primary text-light">
                                <div class="message">{{Message}}</div>
                            </div>
                        </div>
                    </li>
                </div>
            </ul>

            <!-- Chat: Footer -->
            <div class="chat-message">
                <form action="/api/chat-bot" method="post" dmx-on:submit="run([{runJS:{outputType:'text',function:'handleChat',args:[`tsend.value`]}},{run:{name:'reloadchatlist',outputType:'text',action:`scChatListChating.load({search: searchChats.value})`}},{run:{outputType:'text',action:`socket_main.emit(\'chat_message\',{message: tsend.value, chat_room_id: ddChatsChating.data.chat_room_id})`}},{run:{name:'clear input',outputType:'text',action:`apiform1.reset()`}}])" dmx-on:keydown.enter="apiform1.submit()" is="dmx-serverconnect-form" id="apiform1">
                    <button class="btn btn-dark" type="submit">Send</button>
                    <textarea class="form-control" placeholder="Enter a message" id="tsend"></textarea>
                </form>
            </div>

        </div>

        <div class="card card-chat-body border-0  w-100 px-4 px-md-5 py-3 py-md-4 d-flex justify-content-center align-items-center" dmx-show="ddChatsChating.data == null">
            <h5>Support Chats</h5>
            <p>Powered by -</p>
            <img src="assets/images/coz-logo.jpeg" alt="" width="200">
        </div>
    </div>
</div>



<!-- old code  -->
<!-- Server Connects -->
<!-- <dmx-serverconnect id="scMessagesChating" url="/api/chats/chats-support" noload="true" dmx-on:success="run({runJS:{name:'scrollToBottom',outputType:'text',function:'scrollToBottom'}})"></dmx-serverconnect>
<dmx-serverconnect id="scChatListChating" url="/api/chats/chats-list-support" dmx-on:success=""></dmx-serverconnect>
<dmx-serverconnect id="scEndChat" url="/api/chats/chats-end-chat" noload="true" dmx-on:success="notifies_main.success('Chat ended. Please visit transcipt to see the history.')" dmx-on:error="notifies_main.danger('Something went wrong! Please try again after a refresh.')"></dmx-serverconnect> -->
<!-- <dmx-serverconnect id="scAddMeToChat" url="/api/chats/chats-add-me" dmx-param:chat_room_id="" noload="true" dmx-on:success="run([{run:{outputType:'text',action:`notifies_main.success(\'Chat added\')`}},{run:{name:'runSc',outputType:'text',action:`scChatListChating.load({})`}}])" dmx-on:forbidden="notifies_main.info('Sorry someone already took the user.')" dmx-on:error="notifies_main.danger('Something went wrong!')"></dmx-serverconnect> -->
<!-- DD and vars -->
<!-- <dmx-data-detail id="ddChatsChating" dmx-bind:data="scChatListChating.data.finalChatList" key="chat_room_id"></dmx-data-detail>
<dmx-value id="varddChatsChating" dmx-bind:value="ddChatsChating.data" dmx-on:updated="run([{runJS:{name:'handleul',outputType:'text',function:'removeAllUL'}},{run:{outputType:'text',action:`scMessagesChating.load({chat_id: ddChatsChating.data.chat_room_id})`}}])"></dmx-value> -->
<!-- Socket Implementation -->
<!-- <dmx-socket id="socket_main" dmx-on:connect="notifies_main.success('Connected to the server.')" dmx-on:message.chat_message="run({condition:{outputType:'boolean',if:`$event.chat_room_id==ddChatsChating.data.chat_room_id`,then:{steps:{runJS:{name:'appendNewMessage',outputType:'text',function:'handleServerMessage',args:[`$event.message`]}}}}})" dmx-on:message.new_support_required="notifies_main.info('New Chat added in Waiting Room')"></dmx-socket> -->